<%# app/views/reports/sales_by_period.html.erb %>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetailBuddy - Sales by Period Report</title>

    <%# Standard Rails head tags %>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%# JavaScript include %>
    <%= javascript_importmap_tags %>

    <%# Font Awesome link %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <%# --- BEGIN INLINE STYLES (Refined for Appearance) --- %>
    <style>
        /* --- Base Variables (Copied from dashboard.css) --- */
        :root {
            --primary-color: #6c63ff;
            --secondary-color: #4d44d9;
            --accent-color: #50fa7b;
            /* Green */
            --text-color: #f8f9fa;
            --text-secondary: #bdc1c6;
            --bg-color: #1e1e2e;
            --card-bg: #282a36;
            --card-hover: #3a3c4e;
            --input-bg: #44475a;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --border-color: #44475a;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --transition-speed: 0.2s;
            --button-bg: #44475a;
            --button-hover-bg: #5a5c72;
            --link-color: #8be9fd;
            --error-color: #f44336;
            --success-color: #4caf50;
            /* Alt Green */
        }

        /* --- Basic Body/Container --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            line-height: 1.5;
            font-size: 14px;
            margin: 0;
        }

        .dashboard-content {
            padding: 1.5rem;
            max-width: 1100px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        /* --- Header --- */
        .reports-header {
            margin-bottom: 1rem;
            /* Reduced bottom margin */
            padding-bottom: 0.8rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        .reports-title {
            font-size: 1.2rem;
            /* Slightly smaller */
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0;
        }

        .reports-header .text-secondary.small {
            margin-bottom: 0;
            font-size: 0.85em;
        }

        /* --- Date Controls Area --- */
        .date-controls-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            gap: 1rem 1.5rem;
            /* Row and column gap */
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }

        /* --- Date Links & Form Elements --- */
        /* --- Inline Styles for Date Links and Date Picker --- */
        /* Base style for links/buttons */
        .date-link-group a,
        .date-picker-form button,
        /* Includes the submit button initially */
        .back-link a {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            color: var(--text-secondary);
            background-color: var(--button-bg);
            /* Base greyish background */
            text-decoration: none;
            cursor: pointer;
            line-height: 1.4;
            transition: background-color 0.2s ease, color 0.2s ease;
            white-space: nowrap;
            appearance: none;
            /* Attempt to reset browser defaults */
            -webkit-appearance: none;
        }

        /* Explicit rule for the submit button to ENSURE it matches the base style */
        /* --- Inline Styles for Date Links and Date Picker --- */
        /* Base style for links/buttons */
        .date-link-group a,
        .date-picker-form button,
        /* Includes submit button */
        .date-picker-form input[type="submit"],
        /* Explicitly target input submit */
        .back-link a {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            color: var(--text-secondary);
            background-color: var(--button-bg);
            /* Base greyish background */
            text-decoration: none;
            cursor: pointer;
            line-height: 1.4;
            transition: background-color 0.2s ease, color 0.2s ease;
            white-space: nowrap;
            appearance: none;
            /* Reset browser defaults */
            -webkit-appearance: none;
            font-family: inherit;
            /* Ensure font is inherited */
        }

        /* Explicit :hover rule for base style */
        .date-link-group a:hover,
        .date-picker-form button:hover,
        .date-picker-form input[type="submit"]:hover,
        .back-link a:hover {
            background-color: var(--button-hover-bg);
            color: var(--text-color);
            border-color: var(--border-color);
            /* Keep border same on hover */
        }


        /* --- Other Date Picker Styles --- */
        .date-picker-form {
          display: flex;
          align-items: baseline; /* CHANGED: Use baseline alignment */
          gap: 0.6rem;
          margin-bottom: 0.5rem;
      }

        .date-picker-form label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0;
            white-space: nowrap;
        }

        /* ... date input styles ... */
        .date-picker-form input[type="date"] {
            padding: 0.3rem 0.5rem;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: var(--border-radius-sm);
            max-width: 140px;
            line-height: 1.4;
            appearance: none;
            -webkit-appearance: none;
        }

        .date-picker-form input[type="date"]::-webkit-calendar-picker-indicator {
            background-color: var(--text-secondary);
            padding: 3px;
            border-radius: 3px;
            cursor: pointer;
            filter: invert(1);
            margin-left: 3px;
        }

        /* ... rest of your date picker input styles ... */
        /* --- Flash Messages --- */
        .alert {
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 0.9em;
        }

        .alert-danger {
            color: var(--error-color);
            background-color: rgba(244, 67, 54, 0.1);
            border-color: rgba(244, 67, 54, 0.3);
        }

        /* --- Summary Cards - Smaller --- */
        .info-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-md);
            padding: 1rem 1.2rem;
            /* Reduced padding */
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            color: var(--text-color);
            height: 100%;
        }

        .info-card h3 {
            font-size: 0.85rem;
            /* Smaller heading */
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
            /* Reduced space */
            text-align: left;
            flex-shrink: 0;
            text-transform: uppercase;
            /* Added */
            letter-spacing: 0.5px;
            /* Added */
        }

        .info-card p.summary-value {
            font-size: 1.6em;
            /* Slightly smaller value */
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
        }

        /* --- Green Rupee Symbol --- */
        .currency-value {
            color: var(--accent-color);
            /* Green */
        }


        /* --- Tables - Refined --- */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            /* Slightly smaller table text */
            margin-top: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            /* Clip children to rounded corners */
        }

        .report-table th,
        .report-table td {
            padding: 0.6rem 0.8rem;
            /* Reduced padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .report-table th {
            color: var(--text-secondary);
            font-weight: 600;
            background-color: var(--card-hover);
            /* Darker header bg */
            white-space: nowrap;
            border-bottom: 2px solid var(--border-color);
            /* Thicker bottom border */
        }

        .report-table td {
            color: var(--text-secondary);
        }

        .report-table td a {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 500;
        }

        .report-table td a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .report-table td.numeric {
            text-align: right;
            font-family: monospace;
            /* Consistent number display */
        }

        .report-table td.status-paid {
            color: var(--accent-color);
            font-weight: 500;
            text-transform: capitalize;
        }

        /* Subtle Zebra-striping */
        .report-table tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .report-table tbody tr:hover {
            background-color: var(--card-hover);
        }

        .report-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* --- Utilities (Minimal subset for layout/spacing) --- */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -0.75rem;
            margin-left: -0.75rem;
        }

        .col-md-6 {
            position: relative;
            width: 100%;
            padding-right: 0.75rem;
            padding-left: 0.75rem;
        }

        @media (min-width: 768px) {
            .col-md-6 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }

        .g-3 {
            margin-right: -0.75rem;
            margin-left: -0.75rem;
        }

        .g-3>.col-md-6 {
            padding-right: 0.75rem;
            padding-left: 0.75rem;
            margin-bottom: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .mb-4 {
            margin-bottom: 1.5rem !important;
        }

        .mt-4 {
            margin-top: 1.5rem !important;
        }

        .me-2 {
            margin-right: 0.5rem !important;
        }

        .ms-2 {
            margin-left: 0.5rem !important;
        }

        .py-3 {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }

        .fs-5 {
            font-size: 1.25rem !important;
        }

        .fs-6 {
            font-size: 1rem !important;
        }

        .fw-semibold {
            font-weight: 600 !important;
        }

        .fw-medium {
            font-weight: 500 !important;
        }

        .small {
            font-size: .875em;
        }

        .text-secondary {
            color: var(--text-secondary) !important;
        }

        .text-muted {
            color: var(--text-secondary) !important;
        }

        .text-center {
            text-align: center !important;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            /* Add space below responsive wrapper */
        }

        hr {
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 0;
            border-top: 1px solid var(--border-color);
            opacity: 0.25;
        }

        hr.my-4 {
            margin-top: 2rem !important;
            margin-bottom: 1.5rem !important;
        }

        /* Adjusted HR margins */
    </style>
    <%# --- END INLINE STYLES --- %>

</head>

<body>

    <div class="dashboard-content reports-page-container">

        <%# Header %>
        <div class="reports-header">
            <h1 class="reports-title fs-6 fw-semibold">Sales Report</h1> <%# Used fs-6 to match following headers %>
            <span class="text-secondary small">Period: <%= @start_date.strftime('%b %d, %Y') %> to <%= @end_date.strftime('%b %d, %Y') %></span>
        </div>

        <%# Date Controls Container %>
        <div class="date-controls-container">
            <%# Quick Date Selection Links %>
            <div class="date-link-group">
                <span class="small text-muted me-2">Quick View:</span>
                <a href="<%= sales_by_period_report_path(start_date: Time.zone.now.to_date, end_date: Time.zone.now.to_date) %>">Today</a>
                <a href="<%= sales_by_period_report_path(start_date: Time.zone.now.beginning_of_week.to_date, end_date: Time.zone.now.to_date) %>">This Week</a>
                <a href="<%= sales_by_period_report_path(start_date: Time.zone.now.beginning_of_month.to_date, end_date: Time.zone.now.to_date) %>">This Month</a>
                <a href="<%= sales_by_period_report_path(start_date: Time.zone.now.last_month.beginning_of_month.to_date, end_date: Time.zone.now.last_month.end_of_month.to_date) %>">Last Month</a>
            </div>

            <%# Date Picker Form %>
            <%= form_with(url: sales_by_period_report_path, method: :get, local: true, class: "date-picker-form") do |form| %>
            <%= form.label :start_date, "From:", class: "small text-muted" %>
            <%= form.date_field :start_date, value: @start_date %>
            <%= form.label :end_date, "To:", class: "small text-muted ms-2" %>
            <%= form.date_field :end_date, value: @end_date %>
            <%= form.submit "Update" %>
            <% end %>
        </div>

        <%# Flash Messages %>
        <% if flash[:alert] %>
        <div class="alert alert-danger" role="alert">
            <%= flash[:alert] %>
        </div>
        <% end %>

        <%# Overall Summary Cards %>
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="info-card">
                    <h3 class="fs-6 fw-medium">Total Revenue</h3> <%# Removed text-muted class %>
                    <%# ADDED span for currency styling %>
                    <p class="summary-value"><span class="currency-value"><%= number_to_currency(@total_revenue_period, unit: '₹') %></span></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-card">
                    <h3 class="fs-6 fw-medium">Total Transactions</h3> <%# Removed text-muted class %>
                    <p class="summary-value"><%= @total_transactions_period %></p>
                </div>
            </div>
        </div>

        <%# Sales Summary by Day Table %>
        <h3 class="fs-6 fw-semibold mb-3">Sales Summary by Day</h3>
        <div class="table-responsive">
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th class="numeric">Revenue</th>
                        <th class="numeric">Transactions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if @sales_by_day_data.present? %>
                    <% @sales_by_day_data.each do |data| %>
                    <tr>
                        <td><%= data[:date].strftime('%a, %b %d, %Y') %></td>
                        <td class="numeric"><%= number_to_currency(data[:revenue], unit: '₹') %></td>
                        <td class="numeric"><%= data[:transactions] %></td>
                    </tr>
                    <% end %>
                    <% else %>
                    <tr>
                        <td colspan="3" class="text-center text-muted py-3">No sales data found for this period.</td>
                    </tr>
                    <% end %>
                </tbody>
            </table>
        </div>

        <hr class="my-4">

        <%# Paid Invoices in Period Table %>
        <h3 class="fs-6 fw-semibold mb-3">Paid Invoices in Period</h3>
        <div class="table-responsive">
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Invoice ID</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th class="numeric">Total Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <% if @invoices_in_period.present? %>
                    <% @invoices_in_period.each do |invoice| %>
                    <tr>
                        <td><%= link_to "##{invoice.id}", invoice_path(invoice), target: "_blank" %></td>
                        <td><%= invoice.invoice_date.strftime('%Y-%m-%d') %></td>
                        <td><%= link_to (invoice.customer&.name || 'N/A'), edit_customer_path(invoice.customer) rescue (invoice.customer&.name || 'N/A') %></td>
                        <td class="numeric"><%= number_to_currency(invoice.calculated_total_amount, unit: '₹') %></td>
                        <td class="status-paid"><%= invoice.status %></td>
                    </tr>
                    <% end %>
                    <% else %>
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">No paid invoices found for this period.</td>
                    </tr>
                    <% end %>
                </tbody>
            </table>
        </div>

        <%# Back Link %>
        <div class="mt-4 back-link">
            <a href="<%= reports_path %>">← Back to Reports Index</a>
        </div>

    </div> <%# End .dashboard-content %>

</body>

</html>